name: BYLAWS Governance Enforcement

on:
  push:
    branches:
      - '**'
    tags:
      - '**'
  pull_request:
    branches:
      - main

jobs:
  check-names-and-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Enforce branch naming
        if: startsWith(github.ref, 'refs/heads/')
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Branch: $BRANCH_NAME"

          git fetch origin main

          # Check if BYLAWS.md was modified
          if git diff --name-only origin/main...HEAD | grep -q "^BYLAWS.md"; then
            echo "BYLAWS.md modified → enforcing amendment branch name"
            if [[ "$BRANCH_NAME" == "main" ]]; then
              echo "Main branch OK"
            elif [[ "$BRANCH_NAME" =~ ^amendment/[0-9]{4}-[0-9]{2}-[a-z0-9\-]+$ ]]; then
              echo "Amendment branch name OK"
            else
              echo "❌ Invalid branch name. Must be 'main' or 'amendment/YYYY-NN-short-title'"
              exit 1
            fi
          else
            echo "BYLAWS.md not modified → skipping branch name enforcement"
          fi

      - name: Enforce tag naming and version alignment
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Tag: $TAG_NAME"

          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+$ ]]; then
            echo "❌ Invalid tag name. Must follow vMAJOR.MINOR (e.g., v1.0)"
            exit 1
          fi

          # Extract version from BYLAWS.md
          BYLAWS_VERSION=$(grep -i "^Version:" BYLAWS.md | head -n1 | awk '{print $2}')
          if [[ -z "$BYLAWS_VERSION" ]]; then
            echo "❌ No Version found in BYLAWS.md"
            exit 1
          fi
          echo "BYLAWS.md version: $BYLAWS_VERSION"

          # Compare with tag
          EXPECTED_TAG="v$BYLAWS_VERSION"
          if [[ "$TAG_NAME" != "$EXPECTED_TAG" ]]; then
            echo "❌ Tag $TAG_NAME does not match BYLAWS.md version $BYLAWS_VERSION"
            exit 1
          else
            echo "✅ Tag matches BYLAWS.md version"
          fi
