name: Deploy Bylaws to WordPress

on:
  workflow_run:
    workflows: ["BYLAWS Governance Enforcement"]
    types: [completed]

permissions:
  contents: write

jobs:
  deploy:
    name: Convert & publish bylaws
    runs-on: ubuntu-latest
    if: >-
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'v')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Install pandoc
        uses: pandoc/actions/setup@v1

      - name: Convert Markdown to HTML fragment
        run: pandoc BYLAWS.md -f markdown -t html5 -o bylaws.html

      - name: Extract version from BYLAWS.md
        id: version
        run: |
          version=$(grep -m1 '^Version:' BYLAWS.md | sed 's/Version:[[:space:]]*//')
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Deploy to WordPress
        env:
          WP_REST_URL: ${{ secrets.WP_REST_URL }}
          WP_APP_USERNAME: ${{ secrets.WP_APP_USERNAME }}
          WP_APP_PASSWORD: ${{ secrets.WP_APP_PASSWORD }}
        run: |
          HTML_CONTENT=$(cat bylaws.html)

          # Check if a page with slug "bylaws" already exists
          EXISTING=$(curl -s \
            -u "$WP_APP_USERNAME:$WP_APP_PASSWORD" \
            "$WP_REST_URL/wp/v2/pages?slug=bylaws&status=publish,draft")

          PAGE_ID=$(echo "$EXISTING" | jq -r '.[0].id // empty')

          PAYLOAD=$(jq -n \
            --arg title "Bylaws" \
            --arg slug "bylaws" \
            --arg content "$HTML_CONTENT" \
            '{title: $title, slug: $slug, content: $content, status: "publish"}')

          if [ -n "$PAGE_ID" ] && [ "$PAGE_ID" != "null" ]; then
            echo "Updating existing page (ID: $PAGE_ID)..."
            curl -s -f -X POST \
              -u "$WP_APP_USERNAME:$WP_APP_PASSWORD" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "$WP_REST_URL/wp/v2/pages/$PAGE_ID"
          else
            echo "Creating new page..."
            curl -s -f -X POST \
              -u "$WP_APP_USERNAME:$WP_APP_PASSWORD" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" \
              "$WP_REST_URL/wp/v2/pages"
          fi

          echo ""
          echo "Deployed bylaws v${{ steps.version.outputs.version }} to WordPress."

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: Install npm dependencies
        run: npm ci

      - name: Build standalone HTML and PDF
        run: |
          npm run build:html:standalone
          npm run build:pdf

      - name: Create GitHub release with PDF and standalone HTML
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="v${{ steps.version.outputs.version }}"
          gh release create "$VERSION" \
            --title "Bylaws $VERSION" \
            --notes "Official bylaws of the Catholic Digital Commons Foundation, $VERSION." \
            dist/bylaws-standalone.html \
            dist/bylaws.pdf
